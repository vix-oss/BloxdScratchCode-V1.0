<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>BloxdCodeHelp</title>
    <script src="https://unpkg.com/blockly/blockly.min.js"></script>
    <script src="https://unpkg.com/blockly/blocks.min.js"></script>
    <script src="https://unpkg.com/blockly/javascript.min.js"></script>

    <!-- ‰∏çË¶ÅË¶ÜËìã Blockly.JavaScriptÔºåÂõ†ÁÇ∫ÂÆÉÂ∑≤Áî± CDN Âä†Ëºâ -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: #1a1a1a;
            color: #fff;
        }

        /* È†ÇÈÉ®Ê®ôÈ°åÊ¨Ñ - Neon È¢®Ê†º */
        .header {
            background: #000;
            border-bottom: 3px solid #00ff00;
            padding: 12px 20px;
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
        }

        .header h1 {
            color: #00ff00;
            font-size: 22px;
            font-weight: bold;
            text-shadow: 0 0 10px #00ff00;
            margin-right: auto;
        }

        .header-version {
            color: #00ff00;
            font-size: 12px;
            text-shadow: 0 0 5px #00ff00;
        }

        .control-group {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .header-btn {
            padding: 8px 15px;
            border: 2px solid #00ff00;
            background: transparent;
            color: #00ff00;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-shadow: 0 0 5px #00ff00;
            font-size: 12px;
        }

        .header-btn:hover {
            background: #00ff00;
            color: #000;
            box-shadow: 0 0 20px #00ff00;
            text-shadow: none;
        }

        .header-separator {
            width: 2px;
            height: 20px;
            background: #00ff00;
            opacity: 0.5;
        }

        /* ‰∏ªÂÆπÂô® */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Blockly Á∑®ËºØÂçÄ */
        #blocklyDiv {
            flex: 1;
            background: #2a2a2a;
            position: relative;
            overflow: hidden;
        }

        /* Blockly Â∑•ÂÖ∑ÁÆ±Ê®£Âºè */
        .blocklyFlyout {
            background-color: #1a1a1a !important;
        }

        .blocklyFlyoutBackground {
            fill: #1a1a1a !important;
        }

        .blocklyFlyoutLabelBackground {
            fill: #000 !important;
        }

        .blocklyFlyoutLabel {
            fill: #00ff00 !important;
        }

        .blocklyText,
        .blocklyEditableText {
            fill: #000 !important;
        }

        .blocklyHidden {
            display: none !important;
        }

        /* Âè≥ÂÅ¥‰ª£Á¢ºÈù¢Êùø */
        .output-panel {
            width: 35%;
            display: flex;
            flex-direction: column;
            background: #1a1a1a;
            border-left: 2px solid #00ff00;
            overflow: hidden;
        }

        .output-header {
            background: #000;
            color: #00ff00;
            padding: 12px 15px;
            font-weight: bold;
            border-bottom: 2px solid #00ff00;
            text-shadow: 0 0 5px #00ff00;
        }

        #output {
            flex: 1;
            padding: 15px;
            background: #0a0a0a;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            line-height: 1.6;
            color: #00ff00;
            white-space: pre-wrap;
            word-wrap: break-word;
            text-shadow: 0 0 3px #00ff00;
        }

        #output::-webkit-scrollbar {
            width: 8px;
        }

        #output::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        #output::-webkit-scrollbar-thumb {
            background: #00ff00;
            border-radius: 4px;
        }

        #output::-webkit-scrollbar-thumb:hover {
            background: #00cc00;
        }

        .output-actions {
            display: flex;
            gap: 5px;
            padding: 10px;
            background: #000;
            border-top: 2px solid #00ff00;
        }

        .output-actions button {
            flex: 1;
            padding: 8px 10px;
            font-size: 11px;
            background: transparent;
            border: 1px solid #00ff00;
            color: #00ff00;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .output-actions button:hover {
            background: #00ff00;
            color: #000;
            box-shadow: 0 0 10px #00ff00;
        }

        /* Ê®°ÊÖãÊ°ÜÊ®£Âºè */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: #1a1a1a;
            padding: 30px;
            border: 2px solid #00ff00;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 0 30px rgba(0, 255, 0, 0.5);
        }

        .modal-header {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #00ff00;
            text-shadow: 0 0 5px #00ff00;
            border-bottom: 1px solid #00ff00;
            padding-bottom: 10px;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #00ff00;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #00ff00;
            background: #0a0a0a;
            color: #00ff00;
            font-size: 13px;
            font-family: inherit;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn-primary,
        .btn-secondary {
            padding: 10px 20px;
            border: 2px solid #00ff00;
            background: transparent;
            color: #00ff00;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            font-size: 12px;
        }

        .btn-primary:hover {
            background: #00ff00;
            color: #000;
            box-shadow: 0 0 15px #00ff00;
        }

        .btn-secondary:hover {
            background: #00aa00;
            box-shadow: 0 0 10px #00aa00;
        }

        /* ÈüøÊáâÂºèË®≠Ë®à */
        @media (max-width: 1200px) {
            .main-container {
                flex-direction: column;
            }

            .output-panel {
                width: 100%;
                height: 250px;
                border-left: none;
                border-top: 2px solid #00ff00;
            }

            .header {
                flex-direction: column;
                align-items: flex-start;
            }

            .header h1 {
                margin-right: 0;
                width: 100%;
            }

            .control-group {
                width: 100%;
                flex-wrap: wrap;
            }
        }
    </style>
</head>

<body>

    <div class="header">
        <h1>BloxdCodeHelp <span class="header-version">V1.0.0</span></h1>
        <div class="control-group">
            <button class="header-btn" onclick="showProjectModal()">‚ûï Êñ∞Â¢ûÂ∞àÊ°à</button>
            <select id="projectSelect" onchange="loadProject()"
                style="padding: 8px 12px; background: #000; color: #00ff00; border: 2px solid #00ff00; border-radius: 3px; cursor: pointer;">
                <option value="">-- ÈÅ∏ÊìáÂ∞àÊ°à --</option>
            </select>
            <div class="header-separator"></div>
            <button class="header-btn" onclick="showExamples()">üí° Examples</button>
            <button class="header-btn" onclick="showHelp()">‚ùì Help</button>
            <div class="header-separator"></div>
            <button class="header-btn" onclick="saveProject()">üíæ SAVE</button>
            <button class="header-btn" onclick="loadProjectFile()">üìÇ LOAD</button>
            <button class="header-btn" onclick="exportProject()">üì§ EXPORT</button>
            <div class="header-separator"></div>
            <button class="header-btn" onclick="runCode()"
                style="background: #00ff00; color: #000; text-shadow: none;">‚ñ∂ START</button>
        </div>
    </div>

    <div class="main-container">
        <div id="blocklyDiv"></div>

        <div class="output-panel">
            <div class="output-header">
                üìÑ Generated Code
            </div>
            <pre id="output"></pre>
            <div class="output-actions">
                <button onclick="downloadCode()">üì• Download</button>
                <button onclick="copyCode()">üìã Copy</button>
                <button onclick="resetWorkspace()">üîÑ Clear</button>
            </div>
        </div>
    </div>

    <!-- Blockly Â∑•ÂÖ∑ÁÆ± XML -->
    <xml id="toolbox" style="display: none">
        <category name="Events" colour="#ff6b6b">
            <block type="tick"></block>
            <block type="on_player_join"></block>
            <block type="on_player_leave"></block>
            <block type="on_player_chat"></block>
            <block type="on_player_jump"></block>
            <block type="on_respawn_request"></block>
            <block type="player_command"></block>
        </category>

        <category name="Entity" colour="#4ecdc4">
            <block type="get_position"></block>
            <block type="set_position"></block>
            <block type="get_velocity"></block>
            <block type="get_health"></block>
            <block type="set_health"></block>
            <block type="apply_health_change"></block>
            <block type="get_shield_amount"></block>
            <block type="set_shield_amount"></block>
            <block type="get_entity_name"></block>
            <block type="apply_impulse"></block>
            <block type="send_message"></block>
            <block type="broadcast_message"></block>
        </category>

        <category name="World" colour="#74b9ff">
            <block type="get_block_at"></block>
            <block type="set_block_at"></block>
            <block type="play_sound"></block>
        </category>

        <category name="Inventory" colour="#ffd700">
            <block type="give_item"></block>
            <block type="clear_inventory"></block>
        </category>

        <category name="Logic" colour="#fdcb6e">
            <block type="if_condition"></block>
            <block type="if_else_condition"></block>
            <block type="while_loop"></block>
            <block type="for_loop"></block>
        </category>

        <category name="Operators" colour="#fdcb6e">
            <block type="compare_equal"></block>
            <block type="compare_less"></block>
            <block type="compare_greater"></block>
            <block type="logic_and"></block>
            <block type="logic_or"></block>
            <block type="logic_not"></block>
        </category>

        <category name="Math" colour="#95a5a6">
            <block type="math_add"></block>
            <block type="math_subtract"></block>
            <block type="math_multiply"></block>
            <block type="math_divide"></block>
            <block type="random_number"></block>
            <block type="number_value"></block>
        </category>

        <category name="Text" colour="#a29bfe">
            <block type="text_value"></block>
            <block type="text_join"></block>
            <block type="get_my_id"></block>
        </category>

        <category name="Variables" colour="#9b59b6" custom="VARIABLE"></category>
        <category name="Functions" colour="#e74c3c" custom="PROCEDURE"></category>
    </xml>

    <!-- Êñ∞Â¢ûÂ∞àÊ°àÊ®°ÊÖãÊ°Ü -->
    <div id="projectModal" class="modal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">‚ûï Êñ∞Â¢ûÂ∞àÊ°à</div>
            <div class="modal-body">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: #00ff00;">Â∞àÊ°àÂêçÁ®± *</label>
                    <input type="text" id="projectName" placeholder="Ëº∏ÂÖ•Â∞àÊ°àÂêçÁ®±"
                        style="width: 100%; padding: 8px; background: #222; border: 1px solid #00ff00; color: #00ff00;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: #00ff00;">Â∞àÊ°àÈ°ûÂûã *</label>
                    <select id="projectType"
                        style="width: 100%; padding: 8px; background: #222; border: 1px solid #00ff00; color: #00ff00;">
                        <option value="world">üåç World Code (‰∏ñÁïå‰ª£Á¢º - ÊîØÊè¥‰∫ã‰ª∂)</option>
                        <option value="block">üß© Code Block (‰ª£Á¢ºÂ°ä - ‰∏çÊîØÊè¥‰∫ã‰ª∂)</option>
                    </select>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: #00ff00;">ÊèèËø∞ (ÈÅ∏Â°´)</label>
                    <textarea id="projectDesc" placeholder="Ëº∏ÂÖ•Â∞àÊ°àÊèèËø∞..."
                        style="width: 100%; padding: 8px; height: 80px; background: #222; border: 1px solid #00ff00; color: #00ff00; resize: vertical;"></textarea>
                </div>
                <div
                    style="padding: 10px; background: #1a1a1a; border: 1px solid #00ff00; color: #00ff00; font-size: 12px; border-radius: 3px;">
                    <strong>Ë™™ÊòéÔºö</strong><br>
                    ‚Ä¢ World Code: ÊîØÊè¥ÊâÄÊúâ‰∫ã‰ª∂(‰∫ã‰ª∂ÂõûË™ø)Ôºå‰ΩøÁî® playerId<br>
                    ‚Ä¢ Code Block: ‰∏çÊîØÊè¥‰∫ã‰ª∂Ôºå‰ΩøÁî® myId Âíå thisPos
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-primary" onclick="createProject()"
                    style="background: #00ff00; color: #000;">Âª∫Á´ã</button>
                <button class="btn-primary" onclick="closeProjectModal()">ÂèñÊ∂à</button>
            </div>
        </div>
    </div>

    <!-- ÁØÑ‰æãÊ®°ÊÖãÊ°Ü -->
    <div id="examplesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">üìö Code Examples</div>
            <div class="modal-body" style="color: #00ff00; font-size: 12px; max-height: 300px; overflow-y: auto;">
                <p><strong>Welcome Message</strong></p>
                <p>1. Drag "Player Join" block<br />2. Add "Broadcast" inside<br />3. Type your message</p>
                <hr style="border-color: #00ff00; margin: 10px 0;">
                <p><strong>Damage System</strong></p>
                <p>1. Use "on_player_chat" event<br />2. Add "Set Health" block<br />3. Connect to logic</p>
            </div>
            <div class="modal-footer">
                <button class="btn-primary" onclick="closeModal('examplesModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Âπ´Âä©Ê®°ÊÖãÊ°Ü -->
    <div id="helpModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">‚ùì Help & Documentation</div>
            <div class="modal-body" style="color: #00ff00; font-size: 12px; max-height: 300px; overflow-y: auto;">
                <p><strong>Getting Started</strong></p>
                <p>‚Ä¢ Drag blocks from the left panel<br />‚Ä¢ Connect them to create logic<br />‚Ä¢ Click START to run your
                    code</p>
                <p style="margin-top: 10px;"><strong>Common Blocks</strong></p>
                <p>‚Ä¢ <strong>Player Join:</strong> Triggers when player joins<br />
                    ‚Ä¢ <strong>Set Pos:</strong> Move player to position<br />
                    ‚Ä¢ <strong>Set Health:</strong> Modify player health<br />
                    ‚Ä¢ <strong>Broadcast:</strong> Send message to all players</p>
            </div>
            <div class="modal-footer">
                <button class="btn-primary" onclick="closeModal('helpModal')">Close</button>
            </div>
        </div>
    </div>

    <script src="js/blockly-blocks-neon.js"></script>
    <script src="js/toolbox.js"></script>
    <script src="js/project-manager.js"></script>
    <script>
        // Initialize generator registry AFTER blocks are loaded
        // This handles the case where Blockly.JavaScript.forBlock needs to be created
        if (typeof Blockly !== 'undefined' && Blockly.JavaScript) {
            if (!Blockly.JavaScript.forBlock) {
                Blockly.JavaScript.forBlock = {};
            }
            console.log('‚úÖ Generator registry initialized');
        }
    </script>
    <script>
        let workspace = null;
        let currentProjectType = 'world'; // ËøΩËπ§Áï∂ÂâçÂ∞àÊ°àÈ°ûÂûã

        // Wait for Blockly to fully load
        function checkAndInitialize() {
            if (typeof Blockly === 'undefined' || !Blockly.inject) {
                setTimeout(checkAndInitialize, 100);
                return;
            }

            // Additional check: verify generators are loaded
            console.log('üîç Blockly loaded, checking generators...');
            console.log('Blockly.JavaScript type:', typeof Blockly.JavaScript);
            console.log('on_player_join in Blockly.JavaScript:', !!Blockly.JavaScript['on_player_join']);
            console.log('forBlock exists:', !!Blockly.JavaScript.forBlock);
            if (Blockly.JavaScript.forBlock) {
                console.log('on_player_join in forBlock:', !!Blockly.JavaScript.forBlock['on_player_join']);
            }

            initializeBlockly();
        }

        // ÂàùÂßãÂåñ Blockly
        function initializeBlockly() {
            try {
                const toolboxElement = document.getElementById('toolbox');

                if (!toolboxElement) {
                    console.error('‚ùå Toolbox element not found');
                    return;
                }

                console.log('üì¶ Toolbox found, categories:', toolboxElement.querySelectorAll('category').length);

                // ËΩâÊèõ XML ÁÇ∫ Blockly Â∑•ÂÖ∑ÁÆ±ÁµêÊßã
                const toolboxDefinition = Blockly.utils.xml.textToDom(toolboxElement.outerHTML);

                workspace = Blockly.inject('blocklyDiv', {
                    toolbox: toolboxDefinition,
                    grid: {
                        spacing: 20,
                        length: 3,
                        colour: '#444',
                        snap: true
                    },
                    zoom: {
                        controls: true,
                        wheel: true,
                        startScale: 1.0,
                        maxScale: 3,
                        minScale: 0.3
                    },
                    theme: Blockly.Themes.Dark,
                    move: {
                        scrollbars: true,
                        drag: true,
                        wheel: true
                    }
                });

                workspace.addChangeListener(generateCode);
                console.log('‚úÖ Blockly initialized successfully');

                // Ê∑ªÂä†Â∞èÂª∂ÈÅ≤‰ª•Á¢∫‰øù‰ª£Á¢ºÁîüÊàêÂô®Â∑≤Ê∫ñÂÇôÂ•Ω
                setTimeout(generateCode, 100);
            } catch (e) {
                console.error('‚ùå Failed to initialize Blockly:', e);
                console.error('Stack:', e.stack);
                setTimeout(initializeBlockly, 500);
            }
        }

        // ÁîüÊàê‰ª£Á¢º
        function generateCode() {
            if (!workspace) return;

            // Á¢∫‰øù Blockly.JavaScript Â≠òÂú®
            if (!Blockly.JavaScript || typeof Blockly.JavaScript.workspaceToCode !== 'function') {
                document.getElementById('output').textContent = '// Á≠âÂæÖ Blockly ÂàùÂßãÂåñ...';
                setTimeout(generateCode, 100);
                return;
            }

            try {
                // Debug: Check if generators are available
                if (console && console.log) {
                    if (!Blockly.JavaScript['on_player_join'] && (!Blockly.JavaScript.forBlock || !Blockly.JavaScript.forBlock['on_player_join'])) {
                        console.warn('‚ö†Ô∏è on_player_join generator not found when generating code');
                    }
                }

                let code = Blockly.JavaScript.workspaceToCode(workspace);

                // Ê†πÊìöÂ∞àÊ°àÈ°ûÂûãÈÄ≤Ë°å‰ª£Á¢ºËΩâÊèõ
                if (currentProjectType === 'world') {
                    code = transformCodeForWorldCode(code);
                }

                document.getElementById('output').textContent = code || '// Á©∫Â∑•‰ΩúÂçÄ - ÂæûÂ∑¶ÂÅ¥ÊãñÂÖ•Á©çÊú®ÈñãÂßãÁ∑®Á®ã';
            } catch (e) {
                document.getElementById('output').textContent = `// ÈåØË™§: ${e.message}\n\n// Â†ÜÁñäËøΩËπ§:\n${e.stack}`;
                console.error('Code generation error:', e);
                console.error('Stack:', e.stack);
                // Debug: List available generators
                if (Blockly.JavaScript && console && console.log) {
                    console.log('Available generators (first 10):', Object.keys(Blockly.JavaScript).slice(0, 10));
                }
            }
        }

        // ÁÇ∫ World Code ËΩâÊèõ‰ª£Á¢º - Â∞áÊâÄÊúâ ID ÂèÉÊï∏ËΩâÊèõÁÇ∫ playerId
        function transformCodeForWorldCode(code) {
            // Â∞á api.* ÂáΩÊï∏ÁöÑ myId ÂèÉÊï∏ÊõøÊèõÁÇ∫ playerId
            // ‰æãÂ¶Ç: api.setHealth(myId, ...) -> api.setHealth(playerId, ...)

            let transformedCode = code;

            // ÊõøÊèõ API Ë™øÁî®‰∏≠ÁöÑ myId -> playerId
            // ÂåπÈÖç api.ÂáΩÊï∏Âêç(myId ÁöÑÊ®°Âºè
            transformedCode = transformedCode.replace(/api\.(\w+)\(\s*myId/g, 'api.$1(playerId');

            // ÊõøÊèõÊã¨ËôüÂÖßÁöÑ myId -> playerIdÔºàÁî®ÊñºÂ§öÂèÉÊï∏ÁöÑÊÉÖÊ≥ÅÔºâ
            // ‰æãÂ¶Ç: api.setHealth(myId, 20) -> api.setHealth(playerId, 20)
            transformedCode = transformedCode.replace(/,\s*myId/g, ', playerId');

            // ÊõøÊèõÂÖ∂‰ªñ myId ‰ΩøÁî®Ôºà‰ΩÜ‰∏çÊòØÂú®ËÆäÊï∏ËÅ≤ÊòéÊàñ‰∫ã‰ª∂ÂõûË™øÂèÉÊï∏‰∏≠Ôºâ
            // Âè™ÊõøÊèõ api Ë™øÁî®ÊàñÂáΩÊï∏Ë™øÁî®‰∏≠ÁöÑ myId

            return transformedCode;
        }

        // Ë§áË£Ω‰ª£Á¢º
        function copyCode() {
            const code = document.getElementById('output').textContent;
            navigator.clipboard.writeText(code).then(() => {
                alert('‚úì Code copied to clipboard!');
            }).catch(() => {
                alert('‚úó Failed to copy. Please copy manually.');
            });
        }

        // ‰∏ãËºâ‰ª£Á¢º
        function downloadCode() {
            const code = document.getElementById('output').textContent;
            const filename = `bloxd-code-${Date.now()}.js`;

            const element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(code));
            element.setAttribute('download', filename);
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
            alert(`‚úì File downloaded: ${filename}`);
        }

        // ÈáçÁΩÆÂ∑•‰ΩúÂçÄ
        function resetWorkspace() {
            if (confirm('Are you sure you want to clear all blocks?')) {
                workspace.clear();
                generateCode();
            }
        }

        // ÈÅãË°å‰ª£Á¢º
        function runCode() {
            const code = document.getElementById('output').textContent;
            try {
                eval(code);
                alert('‚úì Code executed successfully!');
            } catch (e) {
                alert(`‚úó Runtime Error: ${e.message}`);
            }
        }

        // ============ Â∞àÊ°àÁÆ°ÁêÜÂáΩÊï∏ ============
        function showProjectModal() {
            document.getElementById('projectModal').classList.add('show');
        }

        function closeProjectModal() {
            document.getElementById('projectModal').classList.remove('show');
            document.getElementById('projectName').value = '';
            document.getElementById('projectType').value = 'world';
            document.getElementById('projectDesc').value = '';
        }

        function createProject() {
            const name = document.getElementById('projectName').value.trim();
            const type = document.getElementById('projectType').value;
            const description = document.getElementById('projectDesc').value.trim();

            if (!name) {
                alert('‚ùå Ë´ãËº∏ÂÖ•Â∞àÊ°àÂêçÁ®±');
                return;
            }

            projectManager.createProject(name, type, description);
            currentProjectType = type; // Ë®≠ÂÆöÁï∂ÂâçÂ∞àÊ°àÈ°ûÂûã
            closeProjectModal();
            updateProjectList();
            selectProject(projectManager.currentProject.id);

            // ÈáçÁΩÆÂ∑•‰ΩúÂçÄ‰∏¶Ë®≠ÁΩÆÈÅ©Áï∂ÁöÑÊ®°Âºè
            workspace.clear();

            // Âè™Êúâ‰∏ñÁïå‰ª£Á¢ºÊâçËÉΩË®™Âïè‰∫ã‰ª∂
            updateToolbox(type);

            alert(`‚úÖ Â∞àÊ°à "${name}" Â∑≤Âª∫Á´ãÔºÅ`);
        }

        function updateProjectList() {
            const select = document.getElementById('projectSelect');
            select.innerHTML = '<option value="">-- ÈÅ∏ÊìáÂ∞àÊ°à --</option>';

            projectManager.getAllProjects().forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = `${project.name} (${project.type === 'world' ? 'üåç World' : 'üß© Block'})`;
                select.appendChild(option);
            });
        }

        function selectProject(projectId) {
            const select = document.getElementById('projectSelect');
            select.value = projectId;
            loadProject();
        }

        function loadProject() {
            const projectId = document.getElementById('projectSelect').value;
            if (!projectId) {
                workspace.clear();
                projectManager.currentProject = null;
                currentProjectType = 'world'; // ÈáçÁΩÆÁÇ∫ÈªòË™ç
                return;
            }

            const project = projectManager.getProject(projectId);
            if (project) {
                projectManager.currentProject = project;
                currentProjectType = project.type; // Êõ¥Êñ∞Áï∂ÂâçÂ∞àÊ°àÈ°ûÂûã

                // Âè™Êúâ‰∏ñÁïå‰ª£Á¢ºÊâçËÉΩË®™Âïè‰∫ã‰ª∂
                updateToolbox(project.type);

                // ÊÅ¢Âæ©Â∑•‰ΩúÂçÄ
                if (project.workspace) {
                    workspace.clear();
                    try {
                        Blockly.serialization.workspaces.load(project.workspace, workspace);
                    } catch (e) {
                        console.error('Error loading workspace:', e);
                    }
                }

                generateCode();
            }
        }

        function saveCurrentProject() {
            if (!projectManager.currentProject) {
                alert('‚ùå Ë´ãÂÖàÂª∫Á´ãÊàñÈÅ∏Êìá‰∏ÄÂÄãÂ∞àÊ°à');
                return;
            }

            const code = document.getElementById('output').textContent;
            const workspace_data = Blockly.serialization.workspaces.save(workspace);

            projectManager.updateProject(projectManager.currentProject.id, {
                code,
                workspace: workspace_data
            });

            alert(`‚úÖ Â∞àÊ°à "${projectManager.currentProject.name}" Â∑≤‰øùÂ≠òÔºÅ`);
        }

        function exportProject() {
            if (!projectManager.currentProject) {
                alert('‚ùå Ë´ãÂÖàÈÅ∏ÊìáÊàñÂª∫Á´ã‰∏ÄÂÄãÂ∞àÊ°à');
                return;
            }

            saveCurrentProject();
            const project = projectManager.currentProject;

            if (project.type === 'world') {
                exportWorldCodeTemplate();
            } else {
                exportCodeBlock();
            }
        }

        function exportWorldCodeTemplate() {
            const template = `// ===== ‰∏ñÁïå‰ª£Á¢ºÊ®°Êùø =====
// ÊîØÊè¥ÊâÄÊúâ‰∫ã‰ª∂ÂõûË™øÂíå playerId

try { db } catch { db = {} }
if (!db.data) db.data = {};

// ÂÆöÁæ©ÊÇ®ÁöÑ‰∏ñÁïå‰ª£Á¢ºÈÇèËºØ

/* ===== ‰∫ã‰ª∂ËôïÁêÜ ===== */

function onPlayerJoin(playerId, fromGameReset) {
    // Áé©ÂÆ∂Âä†ÂÖ•‰∫ã‰ª∂
}

function onPlayerLeave(playerId, serverIsShuttingDown) {
    // Áé©ÂÆ∂Èõ¢Èñã‰∫ã‰ª∂
}

function onPlayerChat(playerId, message) {
    // Áé©ÂÆ∂ËÅäÂ§©‰∫ã‰ª∂
    return true;
}

tick = (ms) => {
    // ÂÆöÊúüÂü∑Ë°å
};
`;

            const code = document.getElementById('output').textContent;
            const fullCode = template + '\n\n// ===== ÊÇ®ÁöÑËá™ÂÆöÁæ©‰ª£Á¢º =====\n' + code;

            downloadToFile(fullCode, `${projectManager.currentProject.name}-world.js`);
        }

        function exportCodeBlock() {
            const template = `// ===== ‰ª£Á¢ºÂ°äÊ®°Êùø =====
// ‰ΩøÁî® myId Âíå thisPos ËÆäÊï∏
// ‰∏çÊîØÊè¥‰∫ã‰ª∂ÂõûË™ø

// Âú®ÈÄôË£°Á∑®ÂØ´ÊÇ®ÁöÑ‰ª£Á¢ºÂ°äÈÇèËºØ
// myId: Áï∂ÂâçÂØ¶È´î ID
// thisPos: Áï∂Ââç‰ΩçÁΩÆ [x, y, z]
`;

            const code = document.getElementById('output').textContent;
            const fullCode = template + '\n' + code;

            downloadToFile(fullCode, `${projectManager.currentProject.name}-block.js`);
        }

        // ‰øùÂ≠òÂ∞àÊ°à
        function saveProject() {
            saveCurrentProject();
        }

        // Âä†ËºâÂ∞àÊ°àÊñá‰ª∂
        function loadProjectFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.bloxd,.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const project = JSON.parse(event.target.result);
                        // ‰ΩøÁî®Êñ∞Á≥ªÁµ±
                        if (project.workspace) {
                            workspace.clear();
                            Blockly.serialization.workspaces.load(project.workspace, workspace);
                        } else if (project.xml) {
                            // ËàäÊ†ºÂºèÊîØÊè¥
                            const xml = Blockly.Xml.textToDom(project.xml);
                            workspace.clear();
                            Blockly.Xml.domToWorkspace(xml, workspace);
                        }
                        generateCode();
                        alert(`‚úì Â∞àÊ°àÂ∑≤Âä†Ëºâ: ${project.name}`);
                    } catch (err) {
                        alert(`‚úó Âä†ËºâÂ§±Êïó: ${err.message}`);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // È°ØÁ§∫ Examples
        function showExamples() {
            document.getElementById('examplesModal').classList.add('show');
        }

        // È°ØÁ§∫ Help
        function showHelp() {
            document.getElementById('helpModal').classList.add('show');
        }

        // ÈóúÈñâÊ®°ÊÖãÊ°Ü
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // Á™óÂè£ÈªûÊìä‰∫ã‰ª∂ - ÈóúÈñâÊ®°ÊÖãÊ°Ü
        window.addEventListener('click', (event) => {
            const projectModal = document.getElementById('projectModal');
            if (event.target === projectModal) {
                closeProjectModal();
            }
        });

        // ÂàùÂßãÂåñ - Á≠âÂæÖ Blockly Â∫´ÂÆåÂÖ®Âä†Ëºâ
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                checkAndInitialize();
                // ÂàùÂßãÂåñÂ∞àÊ°àÂàóË°®
                if (typeof updateProjectList === 'function') {
                    updateProjectList();
                }
            });
        } else {
            checkAndInitialize();
            if (typeof updateProjectList === 'function') {
                updateProjectList();
            }
        }
    </script>

</body>

</html>